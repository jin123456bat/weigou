<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en">
    <!--<![endif]-->
    <!-- BEGIN HEAD -->

    <head>
        <meta charset="utf-8" />
        <title>添加商品</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta content="width=device-width, initial-scale=1" name="viewport" />
        <meta content="" name="description" />
        <meta content="" name="author" />
        <!-- BEGIN GLOBAL MANDATORY STYLES -->
        <link href="{%$VIEW_ROOT%}/assets/global/css/font.css" rel="stylesheet" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/global/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/global/plugins/simple-line-icons/simple-line-icons.min.css" rel="stylesheet" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/global/plugins/uniform/css/uniform.default.css" rel="stylesheet" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-switch/css/bootstrap-switch.min.css" rel="stylesheet" type="text/css" />
        <!-- END GLOBAL MANDATORY STYLES -->
        <!-- BEGIN PAGE LEVEL PLUGINS -->
        <link href="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css" rel="stylesheet" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/global/plugins/fancybox/source/jquery.fancybox.css" rel="stylesheet" type="text/css" />
		<link rel="stylesheet" type="text/css" href="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-tagsinput/bootstrap-tagsinput.css"/>
        <link href="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-modal/css/bootstrap-modal-bs3patch.css" rel="stylesheet" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-modal/css/bootstrap-modal.css" rel="stylesheet" type="text/css" />
        <!-- END PAGE LEVEL PLUGINS -->
        <!-- BEGIN THEME GLOBAL STYLES -->
        <link href="{%$VIEW_ROOT%}/assets/global/css/components.min.css" rel="stylesheet" id="style_components" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/global/css/plugins.min.css" rel="stylesheet" type="text/css" />
		<link href="{%$VIEW_ROOT%}/umeditor/themes/default/css/umeditor.min.css" rel="stylesheet" type="text/css"/>
		<link href="{%$VIEW_ROOT%}/assets/global/plugins/select2/css/select2-bootstrap.min.css" rel="stylesheet" type="text/css" />
		<link href="{%$VIEW_ROOT%}/assets/global/plugins/select2/css/select2.min.css" rel="stylesheet" type="text/css" />
        <!-- END THEME GLOBAL STYLES -->
        <!-- BEGIN THEME LAYOUT STYLES -->
        <link href="{%$VIEW_ROOT%}/assets/layouts/layout/css/layout.min.css" rel="stylesheet" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/layouts/layout/css/themes/darkblue.min.css" rel="stylesheet" type="text/css" id="style_color" />
        <link href="{%$VIEW_ROOT%}/assets/layouts/layout/css/custom.min.css" rel="stylesheet" type="text/css" />
        <!-- END THEME LAYOUT STYLES -->
        <link rel="shortcut icon" href="favicon.ico" /> </head>
    <!-- END HEAD -->
	<style>
	.bootstrap-tagsinput{width: 100%;height: 38px;}
    .edui-container{
        width:100%;
    }
    .select2-container{
        z-index: 999999999999999999999999999;
    }
	</style>
    <body class="page-header-fixed page-sidebar-closed-hide-logo page-content-white">
        <!-- BEGIN HEADER -->
        {%include file='admin/public/header.html'%}
        <!-- END HEADER -->
        <!-- BEGIN HEADER & CONTENT DIVIDER -->
        <div class="clearfix"> </div>
        <!-- END HEADER & CONTENT DIVIDER -->
        <!-- BEGIN CONTAINER -->
        <div class="page-container">
            <!-- BEGIN SIDEBAR -->
            {%include file='admin/public/sidebar.html'%}
            <!-- END SIDEBAR -->
            <!-- BEGIN CONTENT -->
            <div class="page-content-wrapper">
                <!-- BEGIN CONTENT BODY -->
                <div class="page-content">
                    <!-- BEGIN PAGE HEADER-->
                    <!-- BEGIN THEME PANEL -->
                    {%include file='admin/public/style.html'%}
                    <!-- END THEME PANEL -->
                    <!-- BEGIN PAGE BAR -->
                    <div class="page-bar">
                        <ul class="page-breadcrumb">
                            <li>
                                <a href="index.php">首页</a>
                                <i class="fa fa-circle"></i>
                            </li>
                            <li>
                                <span>商品管理</span>
								<i class="fa fa-circle"></i>
                            </li>
							<li>
                                <span>编辑商品</span>
                            </li>
                        </ul>
                    </div>
                    <!-- END PAGE BAR -->
                    <!-- BEGIN PAGE TITLE-->
                    <h3 class="page-title"> 商品管理
                        <small>编辑商品</small>
                    </h3>
                    <!-- END PAGE TITLE-->
                    <!-- END PAGE HEADER-->
                    <div class="row">
                        <div class="col-md-12">
                            <form class="form-horizontal form-row-seperated" action="#">
							<input type="hidden" value="{%$smarty.get.id|default:0%}" id="product_id">
                                <div class="portlet">
                                    <div class="portlet-title">
                                        <div class="caption">
                                            <i class="fa fa-shopping-cart"></i>{%$product.name%} </div>
                                        <div class="actions btn-set">
											{%if isset($smarty.server.HTTP_REFERER)%}
                                            <button type="button" name="back" class="btn btn-secondary-outline" onClick="history.go(-1);">
                                                <i class="fa fa-angle-left"></i> 后退</button>
											{%/if%}
                                            <button class="btn btn-secondary-outline" type="reset">
                                                <i class="fa fa-reply"></i> 重置</button>
                                            <button class="btn btn-success" id="save">
                                                <i class="fa fa-check"></i> 保存</button>
                                            <button class="btn btn-success" id="saveedit">
                                                <i class="fa fa-check-circle"></i> 保存 & 继续编辑</button>
											<button class="btn btn-danger" id="remove">
												<i class="fa fa-remove"></i> 删除</button>
                                        </div>
                                    </div>
                                    <div class="portlet-body">
                                        <div class="tabbable-bordered">
                                            <ul class="nav nav-tabs">
                                                <li class="active">
                                                    <a href="#tab_general" data-toggle="tab"> 通用 </a>
                                                </li>
												<li>
                                                    <a href="#tab_description" data-toggle="tab"> 详情 </a>
                                                </li>
                                                <li id="outside">
                                                    <a href="#tab_meta" data-toggle="tab"> 海外 </a>
                                                </li>
                                                <li>
                                                    <a href="#tab_publish" data-toggle="tab"> 供货商 </a>
                                                </li>
												<li>
                                                    <a href="#tab_prototype" data-toggle="tab"> 属性 </a>
                                                </li>
                                                <!--
                                                <li>
                                                    <a href="#tab_bind" data-toggle="tab"> 捆绑 </a>
                                                </li>
                                                -->
                                                <li>
                                                    <a href="#tab_images" data-toggle="tab"> 图像 </a>
                                                </li>
                                                <li>
                                                    <a href="#tab_ship" data-toggle="tab"> 配送 </a>
                                                </li>
                                            </ul>
                                            <div class="tab-content">
                                                <div class="tab-pane" id="tab_publish">
                                                    <div class="portlet">
                                                        <div class="portlet-title">
                                                            <button class="btn blue" id="createPublishBtn">添加供应商</button>
                                                        </div>
                                                        <div class="portlet-body">
                                                            <div class="form-body">
                                                                <div class="form-group">
                                                                    <table class="table" id="PublishTable">
                                                                        <thead>
                                                                            <th>供货商</th><th>发货仓库</th><th>SKU</th><th>进价</th><th>原价</th><th>V0价</th><th>V1价</th><th>V2价</th><th>库存</th><th>操作</th>
                                                                        </thead>
                                                                        <tbody>
                                                                            {%section name=pp loop=$product_publish%}
                                                                                <tr data-publish_id="{%$product_publish[pp].publish_id%}" data-store_id="{%$product_publish[pp].store%}">
                                                                                    <td>{%$product_publish[pp].publish_name%}</td>
                                                                                    <td>{%$product_publish[pp].store_name%}</td>
                                                                                    <td>{%$product_publish[pp].sku%}</td>
                                                                                    <td>{%$product_publish[pp].price[0].inprice%}</td>
                                                                                    <td>{%$product_publish[pp].oldprice%}</td>
                                                                                    <td>{%$product_publish[pp].price[0].price%}</td>
                                                                                    <td>{%$product_publish[pp].price[0].v1price%}</td>
                                                                                    <td>{%$product_publish[pp].price[0].v2price%}</td>
                                                                                    <td>{%$product_publish[pp].stock%}</td>
                                                                                    <td>
                                                                                        <button class="btn btn-xs btn-circle blue changePublishBtn">编辑</button>
                                                                                        <button class="btn btn-xs btn-circle red removePublishBtn">删除</button>
                                                                                    </td>
                                                                                </tr>
                                                                            {%/section%}
                                                                        </tbody>
                                                                        {%section name=json loop=$product_publish_json%}
                                                                        <input class="existedPublish{%$product_publish_json[json].publish_id%}" type="hidden" name="publish[]" value="{%$product_publish_json[json].value%}">
                                                                        {%/section%}
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="tab-pane" id="tab_bind">
                                                    <div class="form-body">
                                                        <div class="form-group">
                                                            <table class="table" id="BindTable">
                                                                <thead>
                                                                    <th class="radioPrototypeInBind display-none">规格</th><th>数量</th>
                                                                    <th>单位</th><th>进价</th><th>V0价</th><th>V1价</th><th>V2价</th>
                                                                    <th>排序</th><th>操作</th>
                                                                </thead>
                                                                <tbody>
                                                                    <td class="radioPrototypeInBind display-none">
                                                                        <select class="form-control input-sm" name="content">
                                                                        </select>
                                                                    </td>
                                                                    <td>
                                                                        <input type="text" name="num" class="form-control input-sm">
                                                                    </td>
                                                                    <td>
                                                                        <input type="text" name="unit"
                                                                               class="form-control input-sm">
                                                                    </td>
                                                                    <td>
                                                                        <input type="text" name="inprice" class="form-control input-sm">
                                                                    </td>
                                                                    <td>
                                                                        <input type="text" name="price" class="form-control input-sm">
                                                                    </td>
                                                                    <td>
                                                                        <input type="text" name="v1price" class="form-control input-sm">
                                                                    </td>
                                                                    <td>
                                                                        <input type="text" name="v2price" class="form-control input-sm">
                                                                    </td>
                                                                    <td>
                                                                        <input type="text" name="sort"
                                                                               class="form-control input-sm">
                                                                    </td>
                                                                    <td>
                                                                        <button class="btn btn-sm blue createBindBtn">添加</button>
                                                                    </td>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            	<div class="tab-pane" id="tab_ship">
                                               		<div class="form-body">
                                                    	<div class="form-group">
                                                            <label class="col-md-2 control-label">默认运费:
                                                            </label>
                                                            <div class="col-md-10">
                                                                <input type="text" class="form-control" name="fee" placeholder="" value="{%$product.fee%}"> </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label class="col-md-2 control-label">包邮地区</label>
                                                            <div class="col-md-10">
                                                                <div class="checkbox-list">
                                                                	<table>
                                                                	<tr>
                                                                    {%section name=province loop=$province%}
                                                                    <td>
                                                                    <label class="checkbox-inline">
                                                                        <input type="checkbox" {%if in_array($province[province].id,$product_province)%}checked="checked"{%/if%} name="fee_province" value="{%$province[province].id%}"> {%$province[province].name|truncate:2:''%}
                                                                    </label>
                                                                    </td>
                                                                    {%if ($smarty.section.province.index+1)%10 == 0%}
                                                                    </tr><tr>
                                                                    {%/if%}
                                                                    {%/section%}
                                                                    </tr>
                                                                    </table>
                                                                    <div class="col-md-12">
                                                                    	<button class="btn btn-xs yellow" id="selectAll">全选</button>
                                                                        <button class="btn btn-xs yellow" id="selectElse">反选</button>
                                                                        <button class="btn btn-xs yellow" id="selectZJH">江浙沪</button>
                                                                        <button class="btn btn-xs yellow" id="selectPIAN">偏远地区</button>
                                                                    </div>
                                                                </div>
                                                                
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="tab-pane active" id="tab_general">
                                                    <div class="form-body">
                                                    	<div class="form-group">
                                                            <label class="col-md-2 control-label">商品类型:
                                                                <span class="required"> * </span>
                                                            </label>
                                                            <div class="col-md-10">
                                                            	<select name="outside" class="form-control">
                                                                	<option value="0" {%if $product.outside==0%}selected="selected"{%/if%}>普通商品</option>
                                                                    <option value="1" {%if $product.outside==1%}selected="selected"{%/if%}>进口商品</option>
                                                                    <option value="2" {%if $product.outside==2%}selected="selected"{%/if%}>直供商品</option>
                                                                    <option value="3" {%if $product.outside==3%}selected="selected"{%/if%}>直邮商品</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label class="col-md-2 control-label">名称:
                                                                <span class="required"> * </span>
                                                            </label>
                                                            <div class="col-md-10">
                                                                <input type="text" value="{%$product.name%}" class="form-control" name="name" placeholder=""> </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label class="col-md-2 control-label">短描述:
                                                                <span class="required"> * </span>
                                                            </label>
                                                            <div class="col-md-10">
                                                                <textarea class="form-control" name="short_description">{%$product.short_description%}</textarea>
                                                                <span class="help-block"> 商品列表中显示 </span>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label class="col-md-2 control-label">分类:
                                                                <span class="required"> * </span>
                                                            </label>
                                                            <div class="col-md-10">
                                                                <div class="form-control height-auto">
                                                                    <div class="scroller" style=" height:200px; overflow:auto">
                                                                        <ul class="list-unstyled">
                                                                        	{%section name=category loop=$category%}
                                                                            {%if empty($category[category].cid)%}
                                                                            <li>
                                                                                <label>
                                                                                    <input class="category" type="checkbox" name="category[]" value="{%$category[category].id%}" {%section name=product_category loop=$product_category%}{%if $product_category[product_category].id==$category[category].id%}checked=checked{%/if%}{%/section%}>{%$category[category].name%}--{%$category[category].alias%}</label>
                                                                                <ul class="list-unstyled">
                                                                                    {%section name=subcate loop=$category%}
                                                                                    {%if $category[subcate].cid==$category[category].id%}
                                                                                    <li>
                                                                                        <label>
                                                                                            <input class="category" type="checkbox" name="category[]" value="{%$category[subcate].id%}" {%section name=product_category loop=$product_category%}{%if $product_category[product_category].id==$category[subcate].id%}checked=checked{%/if%}{%/section%}>{%$category[subcate].name%}--{%$category[subcate].alias%}</label>
                                                                                        <ul class="list-unstyled">
                                                                                            {%section name=subcatee loop=$category%}
                                                                                            {%if $category[subcatee].cid==$category[subcate].id%}
                                                                                            <li>
                                                                                                <label>
                                                                                                    <input class="category"  type="checkbox"  name="category[]" value="{%$category[subcatee].id%}"  {%section name=product_category  loop=$product_category%}{%if  $product_category[product_category].id==$category[subcatee].id%}checked=checked{%/if%}{%/section%}>{%$category[subcatee].name%}--{%$category[subcatee].alias%}</label>

                                                                                            </li>
                                                                                            {%/if%}
                                                                                            {%/section%}
                                                                                        </ul>
                                                                                    </li>
                                                                                    {%/if%}
                                                                                    {%/section%}
                                                                                </ul>

                                                                                    </li>
                                                                                     {%/if%}
                                                                                    {%/section%}
                                                                                </ul>
                                                                        
                                                                    </div>
                                                                </div>
                                                                <span class="help-block"> 选择一个或多个分类 </span>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label class="col-md-2 control-label">条形码:
                                                                <span class="required"> * </span>
                                                            </label>
                                                            <div class="col-md-10">
                                                                <input type="text" class="form-control" name="barcode" placeholder="" value="{%$product.barcode%}"> </div>
                                                        </div>
                                                        
                                                        <div class="form-group">
                                                            <label class="col-md-2 control-label">计量单位:<span class="required"> * </span></label>
                                                            <div class="col-md-10">
                                                                <select name="MeasurementUnit" class="form-control select2">
                                                                    <option>请选择...</option>
                                                                        {%section name=MeasurementUnit loop=$MeasurementUnit%}
                                                                        <option value="{%$MeasurementUnit[MeasurementUnit].id%}" {%if $product.MeasurementUnit==$MeasurementUnit[MeasurementUnit].id%}selected=selected{%/if%}>{%$MeasurementUnit[MeasurementUnit].name%}</option>
                                                                        {%/section%}
                                                                </select>
                                                            </div>
                                                        </div>
														<div class="form-group">
															<label class="col-md-2 control-label">标签</label>
															<div class="col-md-10">
																<input type="text" class="form-control" value="{%$product.tags%}" data-role="tagsinput" name="tags" placeholder="说明标签">
															</div>
														</div>
														<div class="form-group">
                                                            <label class="col-md-2 control-label">来源国:</label>
                                                            <div class="col-md-10">
                                                                <select name="origin" class="form-control select2">
																	<option>请选择...</option>
																		{%section name=origin loop=$origin%}
																		<option value="{%$origin[origin].id%}" {%if $product.origin==$origin[origin].id%}selected=selected{%/if%}>{%$origin[origin].name%}</option>
																		{%/section%}
																</select>
                                                            </div>
                                                        </div>
														<div class="form-group">
                                                            <label class="col-md-2 control-label">自动上下架:</label>
                                                            <div class="col-md-10">
                                                                <input type="checkbox" name="auto_status" {%if $product.auto_status==1%}checked=checked{%/if%} id="auto_status">
																<span class="help-block"> 按照销售日期自动调整上下架状态. </span>
                                                            </div>
                                                        </div>
														<div class="form-group">
                                                            <label class="col-md-2 control-label">销售日期:
                                                            </label>
                                                            <div class="col-md-10">
                                                                <div class="input-group input-large date-picker input-daterange" data-date-format="yyyy-mm-dd">
                                                                    <input type="text" id="time_from" value="{%$product.avaliabletime_from|date_format:'Y-m-d H:i:s'%}" {%if $product.auto_status==0%}disabled="disabled"{%/if%} class="form-control" name="product[available_from]">
                                                                    <span class="input-group-addon"> 到 </span>
                                                                    <input type="text" id="time_to" value="{%$product.avaliabletime_to|date_format:'Y-m-d H:i:s'%}" {%if $product.auto_status==0%}disabled="disabled"{%/if%} class="form-control" name="product[available_to]"> </div>
                                                                <span class="help-block"> 销售时间区间. </span>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label class="col-md-2 control-label">状态:
                                                                <span class="required"> * </span>
                                                            </label>
                                                            <div class="col-md-10">
                                                                <select class="table-group-action-input form-control input-medium" name="status">
                                                                    <option value="">请选择...</option>
                                                                    <option value="1" {%if $product.status==1%}selected=selected{%/if%}>上架</option>
                                                                    <option value="0" {%if $product.status==0%}selected=selected{%/if%}>下架</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label class="col-md-2 control-label">下架原因:
                                                            </label>
                                                            <div class="col-md-10">
                                                                <input type="text" class="form-control" name="down_reason" value="{%$product.down_reason%}" placeholder=""> </div>
                                                        </div>
														<div class="form-group">
                                                            <label class="col-md-2 control-label">排序:</label>
                                                            <div class="col-md-10">
                                                                <input type="text" class="form-control" value="{%$product.sort%}" name="sort" placeholder="">
																<span class="help-block">从小到大</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
												<div class="tab-pane" id="tab_description">
													<div class="form-body">
														<div class="form-group">
                                                            <label class="col-md-2 control-label">描述:
                                                                <span class="required"> * </span>
                                                            </label>
                                                            <div class="col-md-10">
																<script id="description" name="description" type="text/plain">{%$product.description%}</script>
                                                            </div>
                                                        </div>
													</div>
												</div>
                                                <div class="tab-pane" id="tab_meta">
                                                    <div class="form-body">
                                                    	<div class="form-group" id="ztax">
                                                            <label class="col-md-2 control-label">综合税:</label>
                                                            <div class="col-md-10">
                                                                <select name="ztax" class="form-control select2">
																	<option>请选择...</option>
																		{%section name=ztax loop=$ztax%}
																		<option value="{%$ztax[ztax].id%}" {%if $product.ztax == $ztax[ztax].id%}selected="selected"{%/if%}>{%$ztax[ztax].name%}({%($ztax[ztax].xtax+$ztax[ztax].ztax)/(1-$ztax[ztax].xtax)*0.7%})</option>
																		{%/section%}
																</select>
                                                            </div>
                                                        </div>
														<div class="form-group" id="postTaxNo">
                                                            <label class="col-md-2 control-label">行邮税号:</label>
                                                            <div class="col-md-10">
                                                                <select name="postTaxNo" class="form-control select2">
																	<option>请选择...</option>
																		{%section name=postTaxNo loop=$postTaxNo%}
																		<option value="{%$postTaxNo[postTaxNo].id%}" {%if $product.postTaxNo==$postTaxNo[postTaxNo].id%}selected{%/if%}>{%$postTaxNo[postTaxNo].name%}</option>
																		{%/section%}
																</select>
                                                            </div>
                                                        </div>
														<div class="form-group">
                                                            <label class="col-md-2 control-label">免税:</label>
                                                            <div class="col-md-10">
                                                                <input type="checkbox" name="freetax" class="form-control" {%if $product.freetax==1%}checked="checked"{%/if%}>
																<span class="help-block">勾选此项不计算税费</span>
                                                            </div>
                                                        </div>
														<div class="form-group">
                                                            <label class="col-md-2 control-label">包装:</label>
                                                            <div class="col-md-10">
                                                                <select name="package" class="form-control select2">
																	<option>请选择...</option>
																		{%section name=package loop=$package%}
																		<option value="{%$package[package].id%}" {%if $product.package==$package[package].id%}selected=selected{%/if%}>{%$package[package].name%}</option>
																		{%/section%}
																</select>
                                                            </div>
                                                        </div>
														
														<div class="form-group">
                                                            <label class="col-md-2 control-label">类目编码:</label>
                                                            <div class="col-md-10">
                                                                <input type="text" name="categoryCode" value="{%$product.categoryCode%}" class="form-control maxlength-handler" maxlength="10">
																<span class="help-block">10个字符</span>
                                                            </div>
                                                        </div>
														<div class="form-group">
                                                            <label class="col-md-2 control-label">毛重:</label>
                                                            <div class="col-md-10">
                                                                <input type="text" name="grossWeight" value="{%$product.grossWeight%}" class="form-control" maxlength="10">
																<span class="help-block">单位KG</span>
                                                            </div>
                                                        </div>
														<div class="form-group">
                                                            <label class="col-md-2 control-label">商品货号:</label>
                                                            <div class="col-md-10">
                                                                <input type="text" name="goodsItemNo" value="{%$product.goodsItemNo%}" class="form-control maxlength-handler" maxlength="24">
																<span class="help-block">24个字符</span>
                                                            </div>
                                                        </div>
														<div class="form-group">
                                                            <label class="col-md-2 control-label">规格型号:</label>
                                                            <div class="col-md-10">
                                                                <input type="text" name="goodsModel" value="{%$product.goodsModel%}" class="form-control maxlength-handler" maxlength="24">
																<span class="help-block">24个字符</span>
                                                            </div>
                                                        </div>
														<div class="form-group">
                                                            <label class="col-md-2 control-label">价格币种:</label>
                                                            <div class="col-md-10">
                                                                <select name="currencyType" class="form-control select2">
																	<option>请选择...</option>
																		{%section name=currency loop=$currency%}
																		<option value="{%$currency[currency].id%}" {%if $product.currencyType==$currency[currency].id%}selected=selected{%/if%}>{%$currency[currency].name%}</option>
																		{%/section%}
																</select>
																<span class="help-block">价格的计算单位</span>
                                                            </div>
                                                        </div>
														<div class="form-group">
                                                            <label class="col-md-2 control-label">商品用途:</label>
                                                            <div class="col-md-10">
                                                                <input type="text" value="{%$product.purpose%}" name="purpose" class="form-control maxlength-handler" maxlength="128">
																<span class="help-block">128个字符</span>
                                                            </div>
                                                        </div>
														<div class="form-group">
                                                            <label class="col-md-2 control-label">第一单位:</label>
                                                            <div class="col-md-10">
                                                                <select name="firstUnit" class="form-control select2">
																	<option>请选择...</option>
																		{%section name=package loop=$package%}
																		<option value="{%$package[package].id%}" {%if $product.firstUnit==$package[package].id%}selected=selected{%/if%}>{%$package[package].name%}</option>
																		{%/section%}
																</select>
																<span class="help-block">第一单位</span>
                                                            </div>
                                                        </div>
														<div class="form-group">
                                                            <label class="col-md-2 control-label">产品国检备案编号:</label>
                                                            <div class="col-md-10">
                                                                <input type="text" name="productRecordNo" value="{%$product.productRecordNo%}" class="form-control maxlength-handler" maxlength="12">
																<span class="help-block">12个字符</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
												<div class="tab-pane" id="tab_prototype">
													<div class="form-body">
														<div class="row">
															<div class="col-md-4">
																<input type="text" class="form-control" style="height:38px;" name="prototype_name" placeholder="属性名">
															</div>
															<div class="col-md-3">
																<select class="form-control" name="prototype_type" style="height:38px;">
																	<option value="text">固定值</option>
																	<option value="radio">可选值</option>
																</select>
															</div>
															<div class="col-md-4">
																<div id="prototype_text" style="display: block;">
																<input type="text" class="form-control" style="height:38px;" name="prototype_value" placeholder="属性值">
																</div>
																<div id="prototype_radio" style="display: none;">
																	
																	<input type="text" class="form-control" data-role="tagsinput" name="prototype_value" placeholder="属性值" style="display: block;">
																</div>
															</div>
															<div class="col-md-1">
																<button class="form-contorl btn btn-circle btn-danger" name="prototype_add"><i class="fa fa-plus"></i></button>
															</div>
														</div>
														<hr>
														<table class="table table-hover" id="prototype_container">
														</table>
														<table class="table table-hover" id="prototype_collection">
															<thead><tr><th>属性</th><th>V0价</th><th>V1价</th><th>V2价</th><th>库存</th><th>编码</th><th>图像</th><th>可用</th></tr></thead>
															<tbody>
															</tbody>
														</table>
													</div>
												</div>
                                                <div class="tab-pane" id="tab_images">
                                                    <div class="alert alert-success margin-bottom-10">
                                                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true"></button>
                                                        <i class="fa fa-warning fa-lg"></i> 文件最大不得超过10MB. </div>
                                                    <div id="tab_images_uploader_container" class="text-align-reverse margin-bottom-10">
                                                        <a id="tab_images_uploader_pickfiles" href="javascript:;" class="btn btn-success">
                                                            <i class="fa fa-plus"></i> 选择文件 </a>
                                                        <a data-url="{%url m=api c=common a=upload%}" id="tab_images_uploader_uploadfiles" href="javascript:;" class="btn btn-primary">
                                                            <i class="fa fa-share"></i> 上传文件 </a>
                                                    </div>
                                                    <div class="row">
                                                        <div id="tab_images_uploader_filelist" class="col-md-6 col-sm-12"> </div>
                                                    </div>
                                                    <table class="table table-bordered table-hover" id="photoList">
                                                        <thead>
                                                            <tr role="row" class="heading">
                                                                <th width="8%"> 图像 </th>
                                                                <th width="25%"> 文件名 </th>
                                                                <th width="8%"> 排序 </th>
                                                                <th width="10%"> 列表图 </th>
                                                                <th width="10%"> 详情图 </th>
                                                               
                                                                <th width="10%"> </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
														
                                                            
                                                           
                                                        </tbody>
                                                    </table>
                                                </div>
                                                
                                                
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- END CONTENT BODY -->
            </div>
            <!-- END CONTENT -->
            <!-- BEGIN QUICK SIDEBAR -->
            {%include file='admin/public/quick_sidebar.html'%}
			<!-- END QUICK SIDEBAR -->
        </div>
        <!-- END CONTAINER -->
        <!-- BEGIN FOOTER -->
        {%include file='admin/public/footer.html'%}
        <!-- END FOOTER -->
        <!--[if lt IE 9]>
<script src="{%$VIEW_ROOT%}/assets/global/plugins/respond.min.js"></script>
<script src="{%$VIEW_ROOT%}/assets/global/plugins/excanvas.min.js"></script> 
<![endif]-->
        <!-- BEGIN CORE PLUGINS -->
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/jquery.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/js.cookie.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-hover-dropdown/bootstrap-hover-dropdown.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/jquery-slimscroll/jquery.slimscroll.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/jquery.blockui.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/uniform/jquery.uniform.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-switch/js/bootstrap-switch.min.js" type="text/javascript"></script>
        <!-- END CORE PLUGINS -->
        <!-- BEGIN PAGE LEVEL PLUGINS -->
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-maxlength/bootstrap-maxlength.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/fancybox/source/jquery.fancybox.pack.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/plupload/js/plupload.full.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-modal/js/bootstrap-modalmanager.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-modal/js/bootstrap-modal.js" type="text/javascript"></script>
        <!-- END PAGE LEVEL PLUGINS -->
        <!-- BEGIN THEME GLOBAL SCRIPTS -->
        <script src="{%$VIEW_ROOT%}/assets/global/scripts/app.js" type="text/javascript"></script>
        <!-- END THEME GLOBAL SCRIPTS -->
        <!-- BEGIN PAGE LEVEL SCRIPTS -->
        <script src="{%$VIEW_ROOT%}/assets/pages/scripts/ecommerce-products-edit.js" type="text/javascript"></script>
		<script src="{%$VIEW_ROOT%}/umeditor/umeditor.js" type="text/javascript"></script>
		<script src="{%$VIEW_ROOT%}/umeditor/umeditor.config.js" type="text/javascript"></script>
		<script type="text/javascript" src="{%$VIEW_ROOT%}/umeditor/lang/zh-cn/zh-cn.js"></script>
		<script src="{%$VIEW_ROOT%}/assets/global/plugins/select2/js/select2.full.min.js" type="text/javascript"></script>
		<script src="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-tagsinput/bootstrap-tagsinput.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/jquery-validation/js/jquery.validate.min.js" type="text/javascript"></script>
        <!-- END PAGE LEVEL SCRIPTS -->
        <!-- BEGIN THEME LAYOUT SCRIPTS -->
        <script src="{%$VIEW_ROOT%}/assets/layouts/layout/scripts/layout.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/layouts/layout/scripts/demo.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/layouts/global/scripts/quick-sidebar.min.js" type="text/javascript"></script>
		<script src="{%$VIEW_ROOT%}/assets/pages/scripts/collection.js" type="text/javascript"></script>
		<script type="text/javascript">
        $(document).ready(function(){

        	$.ajaxSetup({
				headers:{
					'X-CSRF-TOKEN':'{%$x_csrf_token%}'
				}
			});

            $('.createBindBtn').on('click',function(){
                var tr = $(this).parents('tr').clone();
                tr.find('.createBindBtn').addClass('removeBindBtn').html('删除').addClass('red').removeClass('blue').removeClass('createBindBtn');
                tr.insertAfter($(this).parents('tr'));
                return false;
            });

            $('#BindTable').on('click','.removeBindBtn',function(){
                $(this).parents('tr').remove();
                return false;
            });
			
			{%if !empty($product_prototype)%}
			
			{%section name=product_prototype loop=$product_prototype%}
			collection.addPrototype('{%$product_prototype[product_prototype].name%}','{%$product_prototype[product_prototype].type%}','{%$product_prototype[product_prototype].value%}');
			{%/section%}
			
			collection.drawCollectionTables();
			collection.drawPrototypeTables();
			
			{%section name=product_collection loop=$product_collection%}
			collection.setCollectionDefaultValue('{%$product_collection[product_collection].content%}','{%$product_collection[product_collection].price%}','{%$product_collection[product_collection].v1price%}','{%$product_collection[product_collection].v2price%}','{%$product_collection[product_collection].stock%}','{%$product_collection[product_collection].sku%}','{%$product_collection[product_collection].logo%}','{%$product_collection[product_collection].logo_id%}',{%$product_collection[product_collection].available%});
			{%/section%}
			{%/if%}
			
			{%section name=product_image loop=$product_image%}
			EcommerceProductsEdit.drawPhoto({%$product_image[product_image].id%},'{%$product_image[product_image].path%}','{%$product_image[product_image].name%}',{%$product_image[product_image].sort%},{%$product_image[product_image].position%});
			{%/section%}


            {%section name=bind loop=$bind%}
            collection.setBind('{%$bind[bind].content%}','{%$bind[bind].num%}', '{%$bind[bind].unit%}','{%$bind[bind].inprice%}','{%$bind[bind].price%}','{%$bind[bind].v1price%}','{%$bind[bind].v2price%}', '{%$bind[bind].sort%}');
            {%/section%}

			
			$('#prototype_radio').find('input[name=prototype_value]').on('itemAdded',function(event){
				var exp = /[^0-9A-Za-z\u4E00-\u9FA5\uF900-\uFA2D]/;
				if(exp.test(event.item))
				{
					alert('只允许数字字母和汉字');
					$(this).tagsinput('remove',event.item);
				}
			});
		
			window.um = UM.getEditor('description');
			
			$.fn.select2.defaults.set("theme", "bootstrap");
			$(".select2").select2({
				placeholder: '请选择',
				width: '100%',
				language: {
				   noResults: function(){
					   return "没有找到任何匹配项";
				   }
			   	},
			});
			
			$('#selectAll').on('click',function(){
				$('input[name=fee_province]').each(function(index, element) {
                    $(element).parent().addClass('checked');
					$(element).attr('checked','checked');
                });
				return false;
			});
			
			
			$('#selectElse').on('click',function(){
				$('input[name=fee_province]').each(function(index, element) {
                    if($(element).parent().hasClass('checked'))
					{
						$(element).parent().removeClass('checked');
						$(element).removeAttr('checked','checked');
					}
					else
					{
						$(element).parent().addClass('checked');
						$(element).attr('checked','checked');
					}
                });
				return false;
			});
			
			var in_array = function(data,array){
				for(var i=0;i<array.length;i++)
				{
					if(array[i] == data)
					{
						return true;
					}
				}
				return false;
			}
			
			$('#selectPIAN').on('click',function(){
				var province = [
					5,21,26,28,29,30,31,32,33,34,35,
				];
				$('input[name=fee_province]').each(function(index, element) {
					if(in_array($(element).val(),province))
					{
						$(element).parent().addClass('checked');
						$(element).attr('checked','checked');
					}
					else
					{
						$(element).parent().removeClass('checked');
						$(element).removeAttr('checked');
					}
                });
				return false;
			});
			
			$('#selectZJH').on('click',function(){
				var province = [9,10,11];
				$('input[name=fee_province]').each(function(index, element) {
					if(in_array($(element).val(),province))
					{
						$(element).parent().addClass('checked');
						$(element).attr('checked','checked');
					}
					else
					{
						$(element).parent().removeClass('checked');
						$(element).removeAttr('checked');
					}
                });
				return false;
			});
			
			$('button[name=prototype_add]').on('click',function(){
				var name = $.trim($('input[name=prototype_name]').val());
				if(name.length==0)
				{
					App.alert({
						container: $('#alert_container').val(), // alerts parent container 
						place: 'append', // append or prepent in container 
						type: 'danger', // alert's type 
						message: '属性名或属性值不得为空',
                        close: true,
						focus: true, // auto scroll to the alert after shown
						closeInSeconds: 3, // auto close after defined seconds 
						icon:'fa fa-remove' // put icon class before the message
					});
					return false;
				}
				var type = $('select[name=prototype_type]').val();
				switch(type)
				{
					case 'text':
						var value = $.trim($('#prototype_text').find('input').val());
					break;
					case 'radio':
						var value = $('#prototype_radio').find('input').val();
					break;
					default:return false;
				}
				
				collection.addPrototype(name,type,value);
				collection.drawCollectionTables();
				collection.drawPrototypeTables();
				
				return false;
			});
			
			$('#prototype_container').on('click','.prototype_remove',function(e){
				var name = $(this).parents('tr').find('td:first').html();
				collection.removePrototype(name);
				return false;
			});
			
			$('#prototype_collection tbody').on('click','img',function(){
				var input = $('<input type="file">');
				var ths = $(this);
				input.trigger('click');
				
				input.on('change',function(){
					var url = '{%url m=api c=common a=upload%}';
					var xhr = new XMLHttpRequest();
					var formData = new FormData();
					formData.append('file',this.files[0]);
					xhr.open('POST',url,true);
					xhr.onload = function(){  
						if(xhr.status == 200 && xhr.readyState == 4)  
						{  
							var response = $.parseJSON(xhr.response);
							if(response.code == 1)
							{
								ths.parent().find('input[name=logo]').val(response.body.id);
								ths.attr('src',response.body.path);
							}
							else
							{
								alert('文件上传失败');
							}
						}
						else
						{
							alert('文件上传失败');
						}
					};
					xhr.send(formData);
					return false;
				});
				
			});
			
			$('select[name=prototype_type]').on('change',function(){
				switch($(this).val())
				{
					case 'text':
						$('#prototype_text').show();
						$('#prototype_radio').hide();
						break;
					case 'radio':
						$('#prototype_radio').show();
						$('#prototype_text').hide();
						break;
				}
			});
			
			$('.maxlength-handler').maxlength({
				limitReachedClass: "label label-danger",
				alwaysShow: true,
				threshold: 5
			});
			
			$('#auto_status').on('click',function(){
				if($(this).is(':checked'))
				{
					$('#time_from').removeAttr('disabled');
					$('#time_to').removeAttr('disabled');
				}
				else
				{
					$('#time_from').attr('disabled','disabled');
					$('#time_to').attr('disabled','disabled');
				}
			});
			
			$('#auto_stock').on('click',function(){
				if($(this).is(':checked'))
				{
					$('input[name=stock]').removeAttr('disabled');
				}
				else
				{
					$('input[name=stock]').attr('disabled','disabled');
				}
			});
			
			$('#save').on('click',function(){
				save();
				window.location = '{%url c=admin a=product%}';
				return false;
			});
			
			$('#saveedit').on('click',function(){
				save();
				return false;
			});
			
			$('#remove').on('click',function(){
				if($('#product_id').val()==0)
				return false;
				var product_id = $('#product_id').val();
				try{
				$.post('{%url m=ajax c=product a=remove%}',{id:product_id},function(response){
					if(response.code==1)
					{
						window.location = '{%url c=admin a=product%}';
					}
					else
					{
						App.alert({
							container: $('#alert_container').val(), // alerts parent container 
							place: 'append', // append or prepent in container 
							type: 'danger', // alert's type 
							message: response.result,
							close: true,
							focus: true, // auto scroll to the alert after shown
							closeInSeconds: 3, // auto close after defined seconds 
							icon:'fa fa-remove' // put icon class before the message
						});
					}
				});
				}
				catch(e)
				{
					console.log(e);
				}
				return false;
			});
			
			function save()
			{
				App.blockUI();
				
				var category = [];
				$('.category:checked').each(function(index, element) {
					category.push($(element).val());
				});
				try{
					var fee_province = [];
					product_province = $('input[name=fee_province]:checked');
					$.each(product_province,function(index,value){
						fee_province.push($(value).val());
					});

                    var publish = [];
                    $('#PublishTable input').each(function(index,value){
                        publish.push($(value).val());
                    });
					
					var obj = {
						prototype:collection.getPrototypeTables(),
						collection:collection.getCollectionTables(),
						image:EcommerceProductsEdit.getPhoto(),
                        bind:collection.getBind(),
						product_publish:publish,

						name:$('#tab_general input[name=name]').val(),
                        description:window.um.getContent(),
                        short_description:$('textarea[name=short_description]').val(),
                        category:category,
                        auto_status:$('#auto_status:checked').length,
                        avaliabletime_from:$('#time_from').val(),
                        avaliabletime_to:$('#time_to').val(),
                        status:$('select[name=status]').val(),
                        outside:$('select[name=outside]').val(),
                        postTaxNo:$('select[name=postTaxNo]').val(),
                        package:$('select[name=package]').val(),
                        origin:$('select[name=origin]').val(),
                        categoryCode:$('input[name=categoryCode]').val(),
                        grossWeight:$('input[name=grossWeight]').val(),
                        goodsItemNo:$('input[name=goodsItemNo]').val(),
                        goodsModel:$('input[name=goodsModel]').val(),
                        currencyType:$('select[name=currencyType]').val(),
                        purpose:$('input[name=purpose]').val(),
                        firstUnit:$('select[name=firstUnit]').val(),
                        productRecordNo:$('input[name=productRecordNo]').val(),
                        sort:$('#tab_general input[name=sort]').val(),
                        tags:$('#tab_general input[name=tags]').val(),
                        freetax:$('input[name=freetax]:checked').length,
                        fee:$('input[name=fee]').val(),
                        fee_province:fee_province,
                        ztax:$('select[name=ztax]').val(),
                        barcode:$('input[name=barcode]').val(),
                        selled:$('#tab_general input[name=selled]').val(),
                        down_reason:$('input[name=down_reason]').val(),
                        MeasurementUnit:$('select[name=MeasurementUnit]').val(),
					};
				}
				catch(e)
				{
					alert('系统异常');
				}
				
				var url = '{%url m=ajax c=product a=save%}';
				obj['id'] = $('#product_id').val();
				$.post(url,obj,function(response){
					if(response.code==1)
					{
						App.alert({
							container: $('#alert_container').val(), // alerts parent container 
							place: 'append', // append or prepent in container 
							type: 'success', // alert's type 
							message: '保存成功',
							close: true,
							focus: true, // auto scroll to the alert after shown
							closeInSeconds: 3, // auto close after defined seconds 
							icon:'fa fa-check' // put icon class before the message
						});
					}
					else
					{
						App.alert({
							container: $('#alert_container').val(), // alerts parent container 
							place: 'append', // append or prepent in container 
							type: 'danger', // alert's type 
							message: response.result,
							close: true,
							focus: true, // auto scroll to the alert after shown
							closeInSeconds: 3, // auto close after defined seconds 
							icon:'fa fa-remove' // put icon class before the message
						});
					}
					App.unblockUI();
				});
			}
			
			var selectMode = function(){
				switch($('select[name=outside]').val())
				{
					case '0':
						$('#outside').hide();
					break;
					case '1':
						$('#outside').hide();
					break;
					case '2':
						$('#outside').show();
						$('#ztax').show();
						$('#postTaxNo').hide();
					break;
					case '3':
						$('#outside').show();
						$('#ztax').hide();
						$('#postTaxNo').show();
					break;
				}
			}
			selectMode();
			$('select[name=outside]').on('change',function(){
				selectMode();
				return false;
			});

            $('#PublishTable').on('click','.removePublishBtn',function(){
                if (window.confirm('确认删除这个供应商?')) {
                    publish_id = $(this).parents('tr').data('publish_id');
                    $('.existedPublish'+publish_id).remove();
                    $(this).parents('tr').remove();
                }
                return false;
            });

            $('#PublishTable').on('click','.changePublishBtn',function(){
                $('#publish').modal('show');
                $('#publish #publishModalMode').val('edit');
                $('#publish #oldPublish_id').val($(this).parents('tr').data('publish_id'));
                
                var data = $('.existedPublish'+$(this).parents('tr').data('publish_id')).val();
                data = $.parseJSON(decodeURIComponent(data));
                
                $('#publishForm').find('input[name=oldprice]').val(data.oldprice);
                $('#publishForm').find('input[name=sku]').val(data.sku);
                $('#publishForm').find('input[name=stock]').val(data.stock);
                $('#publishForm').find('select[name=store]').val(data.store);
                $('#publishForm').find('select[name=publish_id]').val(data.publish_id);
                for(var i=0;i<data.price.length;i++)
                {
                    if ($('#publishForm .priceTable:eq('+i+')').length==0)
                    {
                        $('#createPriceBtn').trigger('click');
                    }
                    $('#publishForm .priceTable:eq('+i+')').find('input[name=selled]').val(data.price[i].selled);
                    $('#publishForm .priceTable:eq('+i+')').find('input[name=inprice]').val(data.price[i].inprice);
                    $('#publishForm .priceTable:eq('+i+')').find('input[name=price]').val(data.price[i].price);
                    $('#publishForm .priceTable:eq('+i+')').find('input[name=v1price]').val(data.price[i].v1price);
                    $('#publishForm .priceTable:eq('+i+')').find('input[name=v2price]').val(data.price[i].v2price);
                }
                return false;
            });

            $('#createPublishBtn').on('click',function(){
                $('#publish').find('.form-group').removeClass('has-error');
                $('#publish').find('.help-block.help-block-error').remove();
                $('#publish').find('input').val('');
                $('#publish').find('select').each(function(index,value){
                    $(value).find('option:first').attr('selected','selected');
                });
                $('#publish').find('.priceTable:not(":first")').remove();
                $('#deletePriceBtn').addClass('display-none');
                $('#createPriceBtn').removeClass('display-none');

                $('#publish').modal('show');
                $('#publish #publishModalMode').val('new');
                return false;
            });

            $('#createPriceBtn').on('click',function(){
                if ($('.priceTable').length<3)
                {
                    var priceTable = $('.priceTable:first').clone();
                    priceTable.find('input').val('');
                    priceTable.find('.form-group').removeClass('has-error');
                    priceTable.find('span.help-block').remove();
                    priceTable.insertAfter($('.priceTable:last'));
                }
                if ($('.priceTable').length == 3)
                {
                    $(this).addClass('display-none');
                }
                else
                {
                    $(this).removeClass('display-none');
                }
                $('#deletePriceBtn').removeClass('display-none');
                return false;
            });

            $('#deletePriceBtn').on('click',function(){
                if ($('.priceTable').length>1)
                {
                    $('.priceTable:last').remove();
                    $('#createPriceBtn').removeClass('display-none');
                }
                if($('.priceTable').length == 1)
                {
                    $(this).addClass('display-none');
                }
                return false;
            });

            $('#publishForm').validate({
                errorElement: 'span', //default input error message container
                errorClass: 'help-block help-block-error', // default input error message class
                focusInvalid: true, // do not focus the last invalid input
                ignore: "", // validate all fields including form hidden input
                messages: {
                    publish_id:{
                        required:"请选择供应商",
                    },
                    sku:{
                        required:"请填写SKU",
                    },
                    inprice:{
                        required:"请填写进价",
                        number: "进价必须是一个数字"
                    },
                    oldprice:{
                        required:"请填写原价",
                        number:'原价必须是一个数字',
                    },
                    price:{
                        required:"请填写销售价",
                        number: "价格应该是一个数字"
                    },
                    v1price:{
                        required:"请填写V1价",
                        number: "价格应该是一个数字"
                    },
                    v2price:{
                        required:"请填写V2价",
                        number: "价格应该是一个数字"
                    },
                    stock:{
                        required:"请填写库存",
                        digits: "库存应该是一个整数"
                    },
                    store:{
                        required:"请选择发货仓库",
                    },
                    sort:{
                        digits:"排序必须使用数字控制",
                    },
                    selled:{
                        digits:"销售数量必须是一个数字",
                        required:'请填写销售数量',
                    }
                },
                rules: {
                    publish_id:{
                        required:true,
                    },
                    sku:{
                        required:true,
                    },
                    inprice:{
                        required:true,
                        number: true
                    },
                    oldprice:{
                        required:true,
                        number:true,
                    },
                    price:{
                        required:true,
                        number: true
                    },
                    v1price:{
                        required:true,
                        number: true
                    },
                    v2price:{
                        required:true,
                        number: true
                    },
                    stock:{
                        required:true,
                        digits: true
                    },
                    store:{
                        required:true,
                    },
                    sort:{
                        digits:true,
                    },
                    selled:{
                        digits:true,
                        required:true,
                    }
                },

                invalidHandler: function(event, validator) { //display error alert on form submit              
                    
                },

                errorPlacement: function(error, element) {
                    if (element.is(':checkbox')) {
                        error.insertAfter(element.closest(".md-checkbox-list, .md-checkbox-inline, .checkbox-list, .checkbox-inline"));
                    } else if (element.is(':radio')) {
                        error.insertAfter(element.closest(".md-radio-list, .md-radio-inline, .radio-list,.radio-inline"));
                    } else if (element.is('select')){
                        element.closest('.form-group .col-md-10').append(error);
                    }else{
                        error.insertAfter(element); // for other inputs, just perform default behavior
                    }
                },

                highlight: function(element) { // hightlight error inputs
                    $(element)
                        .closest('.form-group').addClass('has-error'); // set error class to the control group
                },

                unhighlight: function(element) { // revert the change done by hightlight
                    $(element)
                        .closest('.form-group').removeClass('has-error'); // set error class to the control group
                },

                success: function(label) {
                    label
                        .closest('.form-group').removeClass('has-error'); // set success class to the control group
                },

                submitHandler: function(form) {
                    $(form).find('.form-group').removeClass('has-error');
                    
                    var publish_id = $(form).find('select[name=publish_id]').val();
                    if($('#publish #publishModalMode').val() == 'new' && $('.existedPublish'+publish_id).length>0)
                    {
                        alert('该供应商已经存在');
                        return false;
                    }

                    priceTable = [];
                    if ($(form).find('.priceTable').length==1) {
                        inprice = 0;
                        selled = 0;
                        price = 0;
                        v1price = 0;
                        v2price = 0;
                        priceTableNum = 1;
                    }
                    else
                    {
                        inprice_max = 0;
                        selled_max = 0;
                        price_max = 0;
                        v1price_max = 0;
                        v2price_max = 0;
                        inprice_min = 999999999;
                        selled_min = 9999999999;
                        price_min = 99999999999;
                        v1price_min = 999999999;
                        v2price_min = 9999999999999;
                        priceTableNum = $(form).find('.priceTable').length;
                    }
                    $(form).find('.priceTable').each(function(index,value){
                        if (priceTableNum==1) {
                            inprice = $(value).find('input[name=inprice]').val();
                            selled = $(value).find('input[name=selled]').val();
                            price = $(value).find('input[name=price]').val();
                            v1price = $(value).find('input[name=v1price]').val();
                            v2price = $(value).find('input[name=v2price]').val();
                        }
                        else
                        {
                            if (inprice_max < parseFloat($(value).find('input[name=inprice]').val()))
                            {
                                inprice_max = parseFloat($(value).find('input[name=inprice]').val()).toFixed(2);
                            }
                            if (selled_max < parseFloat($(value).find('input[name=selled]').val()))
                            {
                                selled_max = parseFloat($(value).find('input[name=selled]').val()).toFixed(2);
                            }
                            if (price_max < parseFloat($(value).find('input[name=price]').val()))
                            {
                                price_max = parseFloat($(value).find('input[name=price]').val()).toFixed(2);
                            }
                            if (v1price_max < parseFloat($(value).find('input[name=v1price]').val()))
                            {
                                v1price_max = parseFloat($(value).find('input[name=v1price]').val()).toFixed(2);
                            }
                            if (v2price_max < parseFloat($(value).find('input[name=v2price]').val()))
                            {
                                v2price_max = parseFloat($(value).find('input[name=v2price]').val()).toFixed(2);
                            }
                            if (inprice_min > parseFloat($(value).find('input[name=inprice]').val()))
                            {
                                inprice_min = parseFloat($(value).find('input[name=inprice]').val()).toFixed(2);
                            }
                            if (selled_min > parseFloat($(value).find('input[name=selled]').val()))
                            {
                                selled_min = parseFloat($(value).find('input[name=selled]').val()).toFixed(2);
                            }
                            if (price_min > parseFloat($(value).find('input[name=price]').val()))
                            {
                                price_min = parseFloat($(value).find('input[name=price]').val()).toFixed(2);
                            }
                            if (v1price_min > parseFloat($(value).find('input[name=v1price]').val()))
                            {
                                v1price_min = parseFloat($(value).find('input[name=v1price]').val()).toFixed(2);
                            }
                            if (v2price_min > parseFloat($(value).find('input[name=v2price]').val()))
                            {
                                v2price_min = parseFloat($(value).find('input[name=v2price]').val()).toFixed(2);
                            }
                        }
                        priceTable.push({
                            selled:$(value).find('input[name=selled]').val(),
                            inprice:$(value).find('input[name=inprice]').val(),
                            price:$(value).find('input[name=price]').val(),
                            v1price:$(value).find('input[name=v1price]').val(),
                            v2price:$(value).find('input[name=v2price]').val(),
                        });
                    });

                    var data = {
                        publish_id:publish_id,
                        sku:$(form).find('input[name=sku]').val(),
                        stock:$(form).find('input[name=stock]').val(),
                        store:$(form).find('select[name=store]').val(),
                        oldprice:$(form).find('input[name=oldprice]').val(),
                        price:priceTable
                    };

                    var dataString = encodeURIComponent(JSON.stringify(data));
                    publish_name = $(form).find('select[name=publish_id] option:selected').text();
                    store = $(form).find('select[name=store] option:selected').text();
                    //<td>供货商</td><td>发货仓库</td><td>SKU</td><td>进价</td><td>原价</td><td>V0价</td><td>V1价</td><td>V2价</td><td>库存</td><td><button class="btn btn-xs btn-circle blue changePublishBtn">编辑</button><button class="btn btn-xs btn-circle red removePublishBtn">删除</button></td>
                    var tpl = '<tr data-publish_id="'+publish_id+'" data-store_id="'+data.store+'"><td>'+publish_name+'</td><td>'+store+'</td><td>'+data.sku+'</td><td>'+(priceTableNum==1?inprice:inprice_min+'~'+inprice_max)+'</td><td>'+data.oldprice+'</td><td>'+(priceTableNum==1?price:price_min+'~'+price_max)+'</td><td>'+(priceTableNum==1?v1price:v1price_min+'~'+v1price_max)+'</td><td>'+(priceTableNum==1?v2price:v2price_min+'~'+v2price_max)+'</td><td>'+data.stock+'</td><td><button class="btn btn-xs btn-circle blue changePublishBtn">编辑</button><button class="btn btn-xs btn-circle red removePublishBtn">删除</button></td></tr>';
                    if ($('#publish #publishModalMode').val() == 'new')
                    {
                        $('#PublishTable').append('<input class="existedPublish'+publish_id+'" type="hidden" name="publish[]" value="'+dataString+'">');

                        $('#PublishTable tbody').append(tpl);
                    }
                    else
                    {
                        var oldPublish_id = $('#publish #oldPublish_id').val();
                        //把原来存储的数据删除掉
                        $('.existedPublish'+oldPublish_id).remove();
                        //添加新的数据
                        $('#PublishTable').append('<input class="existedPublish'+publish_id+'" type="hidden" name="publish[]" value="'+dataString+'">');

                        //把原来的数据行删除掉
                        $('#PublishTable tbody tr').each(function(index,value){
                            if ($(value).data('publish_id') == $('#publish #oldPublish_id').val())
                            {
                                $(tpl).insertAfter($(value));
                                $(value).remove();
                                return false;
                            }
                        });
                    }

                    $('#publish').modal('hide');

                    return false;
                }
            });
        });
        </script>
        <!-- END THEME LAYOUT SCRIPTS -->
        <div id="publish" class="modal container fade" tabindex="-1">
            <input type="hidden" id="publishModalMode" value="new">
            <input type="hidden" id="oldPublish_id" value="">
            <form class="form-horizontal" role="form" id="publishForm">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title">供应商编辑</h4>
                </div>
                <div class="modal-body">
                    <div class="form-body">
                        <div class="row">
                            <div class="form-group col-md-6">
                                <label class="col-md-2 control-label">供应商<span class="required"> * </span></label>
                                <div class="col-md-10">
                                    <select name="publish_id" class="form-control select2">
                                        <option value="">请选择...</option>
                                        {%section name=publish loop=$publish%}
                                        <option value="{%$publish[publish].id%}">{%$publish[publish].name%}</option>
                                        {%/section%}
                                    </select>
                                    <span class="help-block"> 选择一个供应商. </span>
                                </div>
                            </div>
                            <div class="form-group col-md-6">
                                <label class="col-md-2 control-label">发货仓库<span class="required"> * </span></label>
                                <div class="col-md-10">
                                    <select name="store" class="form-control select2">
                                        <option value="">请选择...</option>
                                        {%section name=store loop=$store%}
                                        <option value="{%$store[store].id%}">{%$store[store].name%}</option>
                                        {%/section%}
                                    </select>
                                    <span class="help-block"> 供货商提供的库存. </span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group col-md-6">
                                <label class="col-md-2 control-label">SKU<span class="required"> * </span></label>
                                <div class="col-md-10">
                                    <input type="text" class="form-control maxlength-handler" autocomplete="off" placeholder="最长32个字符" maxlength="32" name="sku">
                                    <span class="help-block"> 每一个供应商都应该有不同的SKU. </span>
                                </div>
                            </div>
                            <div class="form-group col-md-6">
                                <label class="col-md-2 control-label">库存<span class="required"> * </span></label>
                                <div class="col-md-10">
                                    <input type="text" class="form-control maxlength-handler" autocomplete="off" placeholder="库存" maxlength="32" name="stock">
                                    <span class="help-block"> 供货商提供的库存. </span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group col-md-6">
                                <label class="col-md-2 control-label">原价<span class="required"> * </span></label>
                                <div class="col-md-10">
                                    <input type="text" class="form-control maxlength-handler" autocomplete="off" placeholder="原价" maxlength="32" name="oldprice">
                                    <span class="help-block"> 商品原价. </span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 priceTable">
                                <div class="form-group col-md-12">
                                    <label class="col-md-4 control-label">数量<span class="required"> * </span></label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control maxlength-handler" autocomplete="off" placeholder="数量" maxlength="32" name="selled">
                                    </div>
                                </div>
                                <div class="form-group col-md-12">
                                    <label class="col-md-4 control-label">成本<span class="required"> * </span></label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control maxlength-handler" autocomplete="off" placeholder="成本" maxlength="32" name="inprice">
                                    </div>
                                </div>
                                <div class="form-group col-md-12">
                                    <label class="col-md-4 control-label">普通<span class="required"> * </span></label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control maxlength-handler" autocomplete="off" placeholder="V0价" maxlength="32" name="price">
                                    </div>
                                </div>
                                <div class="form-group col-md-12">
                                    <label class="col-md-4 control-label">白金<span class="required"> * </span></label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control maxlength-handler" autocomplete="off" placeholder="V1价" maxlength="32" name="v1price">
                                    </div>
                                </div>
                                <div class="form-group col-md-12">
                                    <label class="col-md-4 control-label">钻石<span class="required"> * </span></label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control maxlength-handler" autocomplete="off" placeholder="V2价" maxlength="32" name="v2price">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="form-group col-md-12">&nbsp;</div>
                                <button id="createPriceBtn" class="btn btn-circle green">+</button>
                                <button id="deletePriceBtn" class="btn btn-circle red display-none">x</button>
                                <div class="form-group col-md-12">&nbsp;</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" data-dismiss="modal" class="btn btn-outline dark">关闭</button>
                    <button type="submit" class="btn green">保存</button>
                </div>
            </form>
        </div>
    </body>

</html>
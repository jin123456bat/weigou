<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en">
    <!--<![endif]-->
    <!-- BEGIN HEAD -->

    <head>
        <meta charset="utf-8" />
        <title>分类管理</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta content="width=device-width, initial-scale=1" name="viewport" />
        <meta content="" name="description" />
        <meta content="" name="author" />
        <!-- BEGIN GLOBAL MANDATORY STYLES -->
        <link href="{%$VIEW_ROOT%}/assets/global/css/font.css" rel="stylesheet" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/global/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/global/plugins/simple-line-icons/simple-line-icons.min.css" rel="stylesheet" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/global/plugins/uniform/css/uniform.default.css" rel="stylesheet" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-switch/css/bootstrap-switch.min.css" rel="stylesheet" type="text/css" />
        <!-- END GLOBAL MANDATORY STYLES -->
        <!-- BEGIN THEME GLOBAL STYLES -->
        <link href="{%$VIEW_ROOT%}/assets/global/css/components.min.css" rel="stylesheet" id="style_components" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/global/css/plugins.min.css" rel="stylesheet" type="text/css" />
        <!-- END THEME GLOBAL STYLES -->
        <!-- BEGIN THEME LAYOUT STYLES -->
        <link href="{%$VIEW_ROOT%}/assets/layouts/layout/css/layout.min.css" rel="stylesheet" type="text/css" />
        <link href="{%$VIEW_ROOT%}/assets/layouts/layout/css/themes/darkblue.min.css" rel="stylesheet" type="text/css" id="style_color" />
        <link href="{%$VIEW_ROOT%}/assets/layouts/layout/css/custom.min.css" rel="stylesheet" type="text/css" />
        <!-- END THEME LAYOUT STYLES -->
        <link rel="shortcut icon" href="favicon.ico" /> </head>
    <!-- END HEAD -->

    <body class="page-header-fixed page-sidebar-closed-hide-logo page-content-white">
        <!-- BEGIN HEADER -->
        {%include file='admin/public/header.html'%}
        <!-- END HEADER -->
        <!-- BEGIN HEADER & CONTENT DIVIDER -->
        <div class="clearfix"> </div>
        <!-- END HEADER & CONTENT DIVIDER -->
        <!-- BEGIN CONTAINER -->
        <div class="page-container">
            <!-- BEGIN SIDEBAR -->
            {%include file='admin/public/sidebar.html'%}
            <!-- END SIDEBAR -->
            <!-- BEGIN CONTENT -->
            <div class="page-content-wrapper">
                <!-- BEGIN CONTENT BODY -->
                <div class="page-content">
                    <!-- BEGIN PAGE HEADER-->
                    <!-- BEGIN THEME PANEL -->
                    {%include file='admin/public/style.html'%}
                    <!-- END THEME PANEL -->
                    <!-- BEGIN PAGE BAR -->
                    <div class="page-bar">
                        <ul class="page-breadcrumb">
                            <li>
                                <a href="index.php">首页</a>
                                <i class="fa fa-circle"></i>
                            </li>
                            <li>
                                <span>商品管理</span>
								<i class="fa fa-circle"></i>
                            </li>
							<li>
                                <span>分类管理</span>
                            </li>
                        </ul>
                    </div>
                    <!-- END PAGE BAR -->
                    <!-- BEGIN PAGE TITLE-->
                    <h3 class="page-title">分类管理
                        <small>分类管理</small>
                    </h3>
                    <!-- END PAGE TITLE-->
                    <!-- END PAGE HEADER-->
					<div class="portlet light bordered">
						<div class="portlet-title">
							<div class="caption font-dark">
								<i class="icon-settings font-dark"></i>
								<span class="caption-subject bold uppercase"> 分类表</span>
							</div>
						</div>
						<div class="portlet-body">
						<div class="table-toolbar">
							<div class="row">
								<div class="col-md-6">
									<div class="btn-group">
										<button id="create" class="btn sbold green"> 添加分类
											<i class="fa fa-plus"></i>
										</button>
									</div>
								</div>
							</div>
						</div>
						
						<div class="custom-alerts alert alert-danger display-hide fade in">
							<i class="fa-lg fa fa-warning"></i>
							<span id="#alert"></span>
						</div>
						
						<table id="category" class="table table-hover">
							<thead>
								<tr><th>名称</th><th>LOGO</th><th>排序</th><th>描述</th><th>上级分类</th><th>操作</th></tr>
							</thead>
							<tbody>
								<tr id="new" class="display-hide">
                                	<td><input type="text" class="form-control input-sm" name="name"></td>
                                    <td>
                                    	<img class="img-rounded upload" src="" width="50" height="50" style="cursor:pointer;">
                                        <input type="hidden" class="form-control input-sm" name="logo">
                                    </td>
                                    <td><input type="text" class="form-control input-sm" name="sort"></td>
                                    <td><input type="text" class="form-control input-sm" name="description"></td>
                                    <td>
                                    <select name="cid" class="form-control input-sm">
                                    	<option value="">顶级分类</option>
                                    	{%section name=select loop=$category%}
                                    	<option value="{%$category[select].id%}">{%$category[select].name%}</option>
                                        {%/section%}
                                    </select>
                                    </td>
                                    <td><button class="btn btn-xs green-stripe default createBtn">添加</button></td>
                                </tr>
								{%section name=category loop=$category%}
								<tr>
									<td class="editable" data-type="text" data-name="name">{%$category[category].name%}</td>
									<td class="editable" data-type="img" data-name="logo"><img width="50" height="50" class="img-rounded" src="{%$category[category].logo%}"></td>
									<td class="editable" data-type="text" data-name="sort">{%$category[category].sort%}</td>
									<td class="editable" data-type="text" data-name="description">{%$category[category].description%}</td>
                                    <td class="editable" data-type="select" data-name="cid" data-id="{%$category[category].cid%}" data-option="{%section name=option loop=$category%}{%$category[option].id%}:{%$category[option].name%},{%/section%}">
                                    	{%$category[category].c_name|default:'顶级分类'%}
                                    </td>
									<td>
										<button class="btn btn-xs yellow-stripe default modify" data-id="{%$category[category].id%}">编辑</button>
										<button class="btn btn-xs red-stripe deafult remove" data-id="{%$category[category].id%}">删除</button>
									</td>
								</tr>
								{%/section%}
							</tbody>
						</table>
						</div>
					</div>
                </div>
                <!-- END CONTENT BODY -->
            </div>
            <!-- END CONTENT -->
            <!-- BEGIN QUICK SIDEBAR -->
            {%include file='admin/public/quick_sidebar.html'%}
            <!-- END QUICK SIDEBAR -->
        </div>
        <!-- END CONTAINER -->
        <!-- BEGIN FOOTER -->
        {%include file='admin/public/footer.html'%}
        <!-- END FOOTER -->
        <!--[if lt IE 9]>
<script src="{%$VIEW_ROOT%}/assets/global/plugins/respond.min.js"></script>
<script src="{%$VIEW_ROOT%}/assets/global/plugins/excanvas.min.js"></script> 
<![endif]-->
        <!-- BEGIN CORE PLUGINS -->
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/jquery.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/js.cookie.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-hover-dropdown/bootstrap-hover-dropdown.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/jquery-slimscroll/jquery.slimscroll.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/jquery.blockui.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/uniform/jquery.uniform.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/global/plugins/bootstrap-switch/js/bootstrap-switch.min.js" type="text/javascript"></script>
        <!-- END CORE PLUGINS -->
        <!-- BEGIN THEME GLOBAL SCRIPTS -->
        <script src="{%$VIEW_ROOT%}/assets/global/scripts/app.min.js" type="text/javascript"></script>
        <!-- END THEME GLOBAL SCRIPTS -->
        <!-- BEGIN THEME LAYOUT SCRIPTS -->
        <script src="{%$VIEW_ROOT%}/assets/layouts/layout/scripts/layout.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/layouts/layout/scripts/demo.min.js" type="text/javascript"></script>
        <script src="{%$VIEW_ROOT%}/assets/layouts/global/scripts/quick-sidebar.min.js" type="text/javascript"></script>
        <!-- END THEME LAYOUT SCRIPTS -->
		<script type="text/javascript">
		
		$.ajaxSetup({
			headers:{
				'X-CSRF-TOKEN':'{%$x_csrf_token%}'
			}
		});
			
		$('#category').on('click','.modify',function(){
			var td = $(this).parents('tr').find('td.editable');
			
			$.each(td,function(index,value){
				if($(value).find('input').length!=0)
				return false;
				var type = $(value).data('type');
				switch(type)
				{
					case 'text':
						var old_val = $(value).html();
						var input = $('<input type="text" class="form-control input-sm">');
						$(value).empty().append(input);
						input.val(old_val);
						break;
					case 'select':
						var old_id = $(value).data('id');
						var option = $(value).data('option');
						var name = $(value).data('name');
						option = option.split(',');
						var tpl = $('<select name="'+name+'" class="form-control input-sm"></select>');
						tpl.append('<option value="">顶级分类</value>');
						for(var i=0;i<option.length;i++)
						{
							if(option[i].length!=0)
							{
								var temp = option[i].split(':')
								var selectedString = old_id==temp[0]?'selected="selected"':'';
								tpl.append('<option value="'+temp[0]+'" '+selectedString+'>'+temp[1]+'</option>');
							}
						}
						$(value).empty().append(tpl);
						break;
					case 'img':
						var img = $(value).find('img');
						var name = $(value).data('name');
						$(value).find('img').css({cursor:'pointer'});
						$(value).find('img').on('click',function(){
							var input_file = $('<input type="file">');
							input_file.trigger('click');
							input_file.on('change',function(){
								var file = $(this)[0].files[0];
								var formData = new FormData();
								formData.append('file',file);
								var xhr = new XMLHttpRequest();
								xhr.open('POST','{%url m=api c=common a=upload%}',true);
								xhr.onload = function(){
									if(xhr.status == 200 && xhr.readyState == 4)  
									{
										var response = xhr.response;
										response = $.parseJSON(response);
										img.attr('src',response.body.path);
										$(value).append('<input type="hidden" name="'+name+'" value="'+response.body.id+'">');
									}
								};  
								xhr.send(formData); 
							});
						});
						break;
					default:
					break;
				}
			});
			$(this).html('保存').removeClass('modify').addClass('save');
		});
		
		$('.upload').on('click',function(){
			var ths = $(this);
			var input = $('<input type="file">');
			input.trigger('click');
			input.on('change',function(){
				var file = $(this)[0].files[0];
				var formData = new FormData();
				formData.append('file',file);
				var xhr = new XMLHttpRequest();
				xhr.open('POST','{%url m=api c=common a=upload%}',true);
				xhr.onload = function(){
					if(xhr.status == 200 && xhr.readyState == 4)  
					{
						var response = xhr.response;
						response = $.parseJSON(response);
						ths.attr('src',response.body.path);
						ths.parent().find('input[name=logo]').val(response.body.id);
					}
				};  
				xhr.send(formData); 
			});
		});
		
		
		$('#category').on('click','.save',function(){
			var td = $(this).parents('tr').find('td.editable');
			var obj={
				id:$(this).data('id')
			};
			
			$.each(td,function(index,value){
				if($(value).find('input').length != 0)
				{
					obj[$(value).data('name')] = $(value).find('input').val();
				}
				if($(value).find('select').length != 0)
				{
					obj[$(value).data('name')] = $(value).find('select').val();
				}
			});
			
			var ths = $(this);
			
			$.post('{%url m=ajax c=category a=save%}',obj,function(response){
				if(response.code==1)
				{
					$.each(td,function(index,value){
						if($(value).data('type')=='text')
						{
							$(value).html($(value).find('input').val());
						}
						if($(value).data('type')=='img')
						{
							$(value).find('img').css({cursor:'default'}).off('click');
						}
						if($(value).data('type')=='select')
						{
							$(value).html($(value).find('option:selected').html());
						}
					});
					ths.html('编辑').removeClass('save').addClass('modify');
				}
				else
				{
					$('#alert').html(response.result);
					$('.alert').removeClass('display-hide');
				}
			});
		});
		
		$('#create').on('click',function(){
			$('#new').removeClass('display-hide');
		});
		
		$('.createBtn').on('click',function(){
			var name = $(this).parents('tr').find('input[name=name]').val();
			var sort = $(this).parents('tr').find('input[name=sort]').val();
			var description = $(this).parents('tr').find('input[name=description]').val();
			var logo = $(this).parents('tr').find('input[name=logo]').val();
			var cid = $(this).parents('tr').find('select[name=cid]').val();
			$.post('{%url m=ajax c=category a=create%}',{name:name,sort:sort,description:description,logo:logo,cid:cid},function(response){
				if(response.code==1)
				{
					var tpl = '<tr><td class="editable" data-type="text" data-name="name">'+response.body.name+'</td><td class="editable" data-type="img" data-name="logo"><img width="50" height="50" class="img-rounded" src="'+(response.body.logo==null?'':response.body.logo)+'"></td><td class="editable" data-type="text" data-name="sort">'+response.body.sort+'</td><td class="editable" data-type="text" data-name="description">'+response.body.description+'</td><td>'+response.body.c_name+'</td><td><button class="btn btn-xs yellow-stripe default modify" data-id="'+response.body.id+'">编辑</button><button class="btn btn-xs red-stripe deafult remove" data-id="'+response.body.id+'">删除</button></td></tr>';
					$(tpl).insertAfter($('#category tbody tr:first'));
					$('#new').addClass('display-hide');
					$('#new').find('input').val('');
					$('#new').find('option:first').attr('selected','selected');
				}
				else
				{
					$('#alert').html(response.result);
					$('.alert').removeClass('display-hide');
				}
			});
			return false;
		});
		
		$('#category').on('click','.remove',function(){
			var id = $(this).data('id');
			var ths = $(this);
			$.post('{%url m=ajax c=category a=remove%}',{id:id},function(response){
				if(response.code==1)
				{
					ths.parents('tr').remove();
				}
				else
				{
					$('#alert').html(response.result);
					$('.alert').removeClass('display-hide');
				}
			});
		});
		</script>
    </body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<title>{%$page_title%}</title>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
       	<meta name="renderer" content="webkit">
        <meta content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no" name="viewport" />
        <!-- reset -->
        <link rel="stylesheet" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css">
		<!-- 新 Bootstrap 核心 CSS 文件 -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<!-- 可选的Bootstrap主题文件（一般不用引入） -->
		<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
		<!--icon-->
		<link rel="stylesheet" href="{%$VIEW_ROOT%}/html/css/plugins/font-awesome/css/font-awesome.min.css">
		<!--自定义css-->
		<link rel="stylesheet" href="{%resource path='/html/css/global.css'%}">
		<script type="text/javascript">
			function lpad(num, n)
			{
				return Array(n>(''+num).length?(n-(''+num).length+1):0).join(0)+num;  
			}
		</script>
	</head>
	<body>
		<div id="refundModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<form class="form-horizontal" role="form">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title">全额退款</h4>
						</div>
						<div class="modal-body">
							<input type="hidden" name="orderno" value="">
							<div class="form-group">
								<label class="col-md-2 control-label">原因</label>
								<div class="col-md-9">
									<select name="refund_reason" class="form-control">
										
									</select>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-2 control-label">描述</label>
								<div class="col-md-9">
									<textarea style="resize: none;" placeholder="详细原因描述" name="refund_note" rows="5" class="form-control"></textarea>
								</div>
							</div>
						</div>
						<div class="modal-footer" style="padding: 0px;">
							<div class="modal-button-group">
								<div class="modal-button submit">确认</div>
								<div data-dismiss="modal" class="modal-button">取消</div>
							</div>
						</div>
					</form>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->

		<div id="sendModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<form class="form-horizontal" role="form">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title">单独发货</h4>
						</div>
						<div class="modal-body">
							<input type="hidden" name="order_product_id" value="">
							<div class="form-group">
								<label class="col-md-2 control-label">供货商</label>
								<div class="col-md-9">
									<select name="publish" class="form-control">
										{%section name=publish loop=$publish%}
										<option value="{%$publish[publish].id%}">{%$publish[publish].name%}</option>
										{%/section%}
									</select>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-2 control-label">发货仓库</label>
								<div class="col-md-9">
									<select name="store" class="form-control">
										{%section name=store loop=$store%}
										<option value="{%$store[store].id%}">{%$store[store].name%}</option>
										{%/section%}
									</select>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-2 control-label">配送方</label>
								<div class="col-md-9">
									<select name="ship_type" class="form-control">
										{%section name=ship loop=$ship%}
										<option value="{%$ship[ship].code%}">{%$ship[ship].name%}</option>
										{%/section%}
									</select>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-2 control-label">物流单号</label>
								<div class="col-md-9">
									<input type="text" name="ship_number" class="form-control">
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-2 control-label">备注</label>
								<div class="col-md-9">
									<textarea style="resize: none;" placeholder="详细原因描述" name="ship_note" rows="5" class="form-control"></textarea>
								</div>
							</div>
						</div>
						<div class="modal-footer" style="padding: 0px;">
							<div class="modal-button-group">
								<div class="modal-button submit">确认</div>
								<div data-dismiss="modal" class="modal-button">取消</div>
							</div>
						</div>
					</form>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		
		
		<div id="erpModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<form class="form-horizontal" role="form">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title">推送ERP</h4>
						</div>
						<div class="modal-body">
							<input type="hidden" name="orderno" value="">
							<div class="form-group">
								<label class="col-md-2 control-label">备注</label>
								<div class="col-md-9">
									<textarea style="resize: none;" placeholder="详细原因描述" name="erp_note" rows="5" class="form-control"></textarea>
								</div>
							</div>
						</div>
						<div class="modal-footer" style="padding: 0px;">
							<div class="modal-button-group">
								<div class="modal-button submit">确认</div>
								<div data-dismiss="modal" class="modal-button">取消</div>
							</div>
						</div>
					</form>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		
		<div id="logisticsModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel">
			<div class="modal-dialog" role="document" style="width: 686px;">
				<div class="modal-content" style="margin-top: 20%;">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">物流轨迹</h4>
					</div>
					<div class="modal-body">
						<div class="white-block logistics">
						</div>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->

		{%include file='html/public/header.html'%}
		<div class="body container-fluid">
			<div class="row">
				{%include file='html/public/sidebar.html'%}
				<div class="content">
			  		<div class="content-body">
			  			<div class="white-block">
			  				<div class="wall-block">
								<p>{%$page_title_reverse%}</p>
							</div>
			  			</div>
			  			<div class="divider"></div>
			  			<div class="white-block">
			  			
			  				<div class="tab">
			  					<div class="tab-header">
			  						<a class="tab-title active" href="#all">订单详情</a>
			  					</div>
			  					<div class="tab-body">
			  						<div class="tab-page active" id="all">
										<div class="line"></div>
										
										<div class="panel panel-default" style="width: 48%; display: inline-block;">
											<div class="panel-heading">
												<h3 class="panel-title">基础信息</h3>
											</div>
											<div class="panel-body">
												<div class="half">
													<label>订单编号:{%$order.orderno%}</label>
													<label>订单状态:{%$order.convertStatus%}</label>
													<label>购货人:{%$order.user.name%}{%if !empty($order.msg)%}|{%$order.msg%}{%/if%}</label>
													<label>支付方式:{%if $order.pay_type==alipay%}支付宝{%elseif $order.pay_type=wechat%}微信支付{%/if%}</label>
												</div>
												
												<div class="half">
													<label>下单时间:{%$order.createtime|date_format:"Y-m-d H:i:s"%}</label>
													{%if $order.pay_status!=0%}<label>付款时间:{%$order.pay_time|date_format:"Y-m-d H:i:s"%}</label>{%/if%}
													{%if $order.way_status!=0%}<label>发货时间:{%$order.way_time|date_format:"Y-m-d H:i:s"%}</label>{%/if%}
												</div>
											</div>
										</div>
										
										<div class="space"></div>
										
										<div class="panel panel-default" style="width: 48%; display: inline-block;">
											<div class="panel-heading">
												<h3 class="panel-title">收货人信息</h3>
											</div>
											<div class="panel-body">
												<div class="half">
													<label>收货人:{%$order.address_name%}</label>
													<label>收货地址:{%$order.address_address%}</label>
													<label>身份证号:{%$order.address_identify%}</label>
													<label>手机号:{%$order.address_telephone%}</label>
												</div>
											</div>
										</div>
										
										<div class="panel panel-default" style="width: 48%; display: inline-block;">
											<div class="panel-heading">
												<h3 class="panel-title">会员信息</h3>
											</div>
											<div class="panel-body">
												<div class="half">
													<label>用户名:{%$order.user.name%}</label>
													<label>手机号:{%$order.user.telephone%}</label>
													<label>会员等级:{%if $order.user.vip==0%}普通用户{%elseif $order.user.vip==1%}白金用户{%elseif $order.user.vip==2%}钻石用户{%/if%}</label>
													<label>会员身份:{%if $order.user.master==1%}导师{%elseif $order.user.master==0%}普通{%/if%}</label>
												</div>
												
												<div class="half">
													<label>上级导师:{%$order.user.omasteruser.name%}</label>
													<label>推广人:{%$order.user.ouser.name%}</label>
												</div>
											</div>
										</div>
										
										<table class="table table-hover table-responsive" style="border-color: rgba(228, 228, 228, 1); background-color: rgba(244, 245, 250, 1);border-width: 1px; border-style: solid;">
											<thead>
												<tr>
													<td width="400px">商品名称</td><td>SPU编号</td><td>条形码</td><td>购买价格</td><td>税费</td><td>数量</td><td>商品状态</td><td>库存</td><td>小计</td><td>操作</td>
												</tr>
											</thead>
											<tbody style="background-color: #FFFFFF;">
												{%section name=product loop=$order.product%}
												<tr>
													<td>
														<div style="display: inline-block;width: 70px;height: 60px;vertical-align:middle;">
															<img onerror="this.src='https://placeholdit.imgix.net/~text?txtsize=18&amp;txt=%E6%AD%A4%E5%A4%84%E6%97%A0%E5%9B%BE&amp;w=60&amp;h=60';" src="{%$order.product[product].image%}" width="60px" height="60px">
														</div>
														<div style="display: inline-block;width: 70%;height: 60px;vertical-align:middle;">
															<div style="display: block;width: 100%;word-break: break-all;overflow: hidden;height: 40px;line-height: 20px;">
																{%$order.product[product].name%}
															</div>
															<div style="height:20px;line-height: 20px;width:100%;overflow: hidden;">
																品牌：{%$order.product[product].brand%}
															</div>
														</div>
													</td>
													<td>
														{%$order.product[product].pid%}
													</td>
													<td>
														{%$order.product[product].barcode%}
													</td>
													<td>
														{%$order.product[product].price%}
													</td>
													<td>
														{%$order.product[product].tax%}
													</td>
													<td>
														{%$order.product[product].num%}
													</td>
													<td>
														{%if $order.product[product].status==1%}上架{%elseif $order.product[product].status==0%}下架{%/if%}
													</td>
													<td>
														{%$order.product[product].stock%}
													</td>
													<td>
														{%$order.product[product].price * $order.product[product].num - $order.product[product].price * $order.product[product].num/$order.goodsamount*$order.discount%}
													</td>
													<td>
														<select data-order_product_id="{%$order.product[product].id%}" data-publish="{%$order.product[product].publish%}" data-ship_type="{%$order.product[product].ship_type%}" data-ship_number="{%$order.product[product].ship_number%}" data-store="{%$order.product[product].store_name%}" class="btn btn-xs" style="border: 1px solid #eee;">
															<option disabled="disabled" selected="selected" value="">请选择</option>
															<option {%if !$order.product[product].send%}disabled="disabled"{%/if%} value="send">单独发货</option>
															<option {%if !$order.product[product].changeWay%}disabled="disabled"{%/if%} value="changeWay">更改发货信息</option>
															<option {%if !$order.product[product].allowRefund%}disabled="disabled"{%/if%} value="refund">单独退款</option>
															<option {%if !$order.product[product].allowLogistics%}disabled="disabled"{%/if%} value="logistics">查看物流</option>
														</select>
													</td>
												</tr>
												{%/section%}
											</tbody>
										</table>
										<div class="line"></div>
										<form class="form-horizontal" role="form">
											<div class="form-group">
												<label class="col-md-1 control-label">给用户留言</label>
												<div class="col-md-10">
													<textarea style="resize: none;" placeholder="该备注将显示在用户订单详情中，请谨慎填写" name="msg_to_user" rows="5" class="form-control"></textarea>
												</div>
											</div>
											<div class="form-group">
												<div class="col-md-offset-10">
													<button type="submit" class="btn btn-default">保存</button>
												</div>
											</div>
										</form>
										<div class="line"></div>
										<table class="table table-hover table-responsive table-page" style="border-color: rgba(228, 228, 228, 1); background-color: rgba(244, 245, 250, 1);border-width: 1px; border-style: solid;">
											<thead><tr><td>操作者</td><td>操作时间</td><td>操作前状态</td><td>操作内容</td><td>备注</td></tr></thead>
											<tbody style="background-color: #FFFFFF;">
												{%section name=log loop=$log%}
												<tr><td>{%$log[log].auser.username%}</td><td>{%$log[log].time|date_format:"Y-m-d H:i:s"%}</td><td>{%$log[log].status%}</td><td>{%$log[log].content%}</td><td>{%$log[log].note|default:'<font class="placeholder">暂无备注内容</font>'%}</td></tr>
												{%/section%}
											</tbody>
										</table>
									</div>
			  						
								</div>
							</div>
							
			  			</div>
			  		</div>				  
				</div>
			</div>
		</div>
		<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
		<script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
		<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
		<script src="http://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<!--alert-->
		<script src="//cdn.bootcss.com/bootbox.js/4.4.0/bootbox.min.js"></script>
		<script src="{%resource path='/html/js/table-page.js'%}"></script>
		<!--datatables-->
		<script src="{%resource path='/html/js/datatables.js'%}"></script>
		<script src="{%resource path='/html/js/tab.js'%}"></script>
		<script src="{%resource path='/html/js/global.js'%}"></script>
		<script type="text/javascript">
			$.ajaxSetup({
				headers:{
					'X-CSRF-TOKEN':'{%$x_csrf_token%}'
				}
			});
			
			$('table').on('change','select',function(){
				if($(this).val()=='changeWay')
				{
					var store = $(this).data('store');
					var publish = $(this).data('publish');
					var ship_type = $(this).data('ship_type');
					var ship_number = $(this).data('ship_number');
					
					$('#sendModal').modal('show');
					
					$('#sendModal input[name=order_product_id]').val($(this).data('order_product_id'));
					
					$('#sendModal select[name=publish] option').each(function(index,value){
						if($(value).text() == publish)
						{
							$(value).prop('selected',true);
						}
						else
						{
							$(value).prop('selected',false);
						}
					});
					
					$('#sendModal select[name=store] option').each(function(index,value){
						if($(value).text() == store)
						{
							$(value).prop('selected',true);
						}
						else
						{
							$(value).prop('selected',false);
						}
					});
					
					$('#sendModal select[name=ship_type]').val(ship_type);
					$('#sendModal input[name=ship_number]').val(ship_number);
				}
				$(this).val('');
				return false;
			});
			
			$('#sendModal .submit').on('click',function(){
				
				var order_product_id = $('#sendModal input[name=order_product_id]').val();
				var ship_type = $('#sendModal select[name=ship_type]').val();
				var ship_number = $('#sendModal input[name=ship_number]').val();
				var publish = $('#sendModal select[name=publish]').val();
				var store = $('#sendModal select[name=store]').val();
				var ship_note = $('#sendModal [name=ship_note]').val();
				
				$.post('./index.php?m=ajax&c=order&a=sendProduct',{order_product_id:order_product_id,ship_type:ship_type,ship_number:ship_number,publish:publish,store:store,ship_note:ship_note},function(response){
					if(response.code==1)
					{
						$('sendModal').modal('hide');			
					}
					else
					{
						try{
							bootbox.alert(response.result);
						}catch(e){
							bootbox.alert('无响应');
						}
					}
				});
			
			});
		</script>
	</body>
</html>
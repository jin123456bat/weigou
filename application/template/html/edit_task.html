<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<title>{%$page_title%}</title>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
       	<meta name="renderer" content="webkit">
        <meta content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no" name="viewport" />
        <!-- reset -->
        <link rel="stylesheet" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css">
		<!-- 新 Bootstrap 核心 CSS 文件 -->
        <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<!-- 可选的Bootstrap主题文件（一般不用引入） -->
		<link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
		<!--icon-->
		<link rel="stylesheet" href="{%$VIEW_ROOT%}/html/css/plugins/font-awesome/css/font-awesome.min.css">
		<!--datepicker-->
		<link href="//cdn.bootcss.com/bootstrap-datepicker/1.7.0-RC2/css/bootstrap-datepicker3.min.css" rel="stylesheet">
		<!--自定义css-->
		<link rel="stylesheet" href="{%resource path='/html/css/global.css'%}">
		<link rel="stylesheet" href="{%resource path='/html/css/brand-selector.css'%}">
		<script type="text/javascript">
			function lpad(num, n) {  
				return Array(n>(''+num).length?(n-(''+num).length+1):0).join(0)+num;  
			}
		</script>
	</head>
	<body>
		{%include file='html/public/header.html'%}
		<div class="body container-fluid">
			<div class="row">
				{%include file='html/public/sidebar.html'%}
				<div class="content">
			  		<div class="content-body">
			  			<div class="white-block">
			  				<div class="wall-block">
								<p>{%$page_title_reverse%}</p>
							</div>
			  			</div>
			  			<div class="divider"></div>
			  			<div class="white-block">
			  				<div class="top-tips">
			  					<div class="top-tips-title">
			  						操作提示
			  					</div>
			  					<div class="top-tips-body">
			  						<p>团购活动列表展示商品的团购相关信息。</p>
									<p>可根据条件，如商品名称、店铺名称等搜索团购商品。</p>
									<p>可查看团购商品的订单列表（可进行订单相关操作）。</p>
									<p>可添加、编辑、删除或批量删除团购活动。</p>
			  					</div>
			  				</div>
			  			</div>
			  			<div class="divider"></div>
			  			<div class="white-block">
			  				<form class="form-horizontal" role="form" id="brandForm">
			  					<div class="form-body">
			  						<div class="form-group">
										<label class="col-md-offset-3 col-md-1 control-label">
											已选择商品 <span class="required">*</span>
										</label>
										<div class="col-md-5">
											<style>
												#selectedProduct thead{
													border:1px solid rgba(215, 215, 215, 1) !important;
													background-color: #F1F1F1;
												}
												#selectedProduct thead tr td{
													border-right: 1px solid rgba(215, 215, 215, 1) !important;
													text-align: center;
												}
												#selectedProduct tbody tr td{
													border-right: 1px solid rgba(215, 215, 215, 1) !important;
													text-align: center;
													border-top: 1px solid rgba(215, 215, 215, 1) !important;
												}
											</style>
											<table id="selectedProduct" class="table table-bordered table-hover table-condensed">
												<thead>
												<tr><td>商品图片</td><td>商品编号</td><td>商品名称</td></tr>
												</thead>
												<tbody>
													<tr data-id="{%$task.pid%}">
														<td>
															<img onerror="this.src='https://placeholdit.imgix.net/~text?txtsize=13&txt=%E6%AD%A4%E5%A4%84%E6%97%A0%E5%9B%BE&w=50&h=50';" src="{%$task.product.logo%}" width="50px" height="50px">
														</td>
														<td>
															{%$task.pid%}
														</td>
														<td>
															{%$task.product.name|default:''%}
														</td>
													</tr>
												</tbody>
											</table>
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-offset-3 col-md-1 control-label">活动有效期</label>
										<div class="col-md-5">
											<div class="input-group input-daterange">
												<input type="text" class="form-control" name="start" placeholder="开始时间" value="{%$task.starttime%}">
												<div class="input-group-addon">~</div>
												<input type="text" class="form-control" name="end" placeholder="结束时间" value="{%$task.endtime%}">
											</div>
											<span class="help-block"> 到达结束时间后自动移除，不填写代表不限制时间 </span>
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-offset-3 col-md-1 control-label">
											活动时间/天 <span class="required">*</span>
										</label>
										<div class="col-md-5">
											<input type="text" class="form-control" name="day" placeholder="天" value="{%$task.day%}">
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-offset-3 col-md-1 control-label">
											团购价格 <span class="required">*</span>
										</label>
										<div class="col-md-5">
											<input type="text" class="form-control" name="price" placeholder="￥" value="{%$task.price%}">
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-offset-3 col-md-1 control-label">
											团购人数  <span class="required">*</span>
										</label>
										<div class="col-md-5">
											<input type="text" class="form-control" name="teamnum" placeholder="0" value="{%$task.teamnum%}">
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-offset-3 col-md-1 control-label">赠送经验值</label>
										<div class="col-md-5">
											<input type="text" class="form-control" name="score" placeholder="0" value="{%$task.score%}">
										</div>
									</div>
									<div class="form-group">
										<div class="col-md-offset-4 col-md-5">
											<button type="submit" class="btn btn-blue col-md-2">保存</button>
										</div>
									</div>
			  					</div>
			  				</form>
			  			</div>
			  		</div>				  
				</div>
			</div>
		</div>
		<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
		<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
		<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
		<script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<!-- jquery validate -->
		<script src="//cdn.bootcss.com/jquery-validate/1.16.0/jquery.validate.min.js"></script>
		<!--alert-->
		<script src="//cdn.bootcss.com/bootbox.js/4.4.0/bootbox.min.js"></script>
		<!--datepicker-->
		<script src="//cdn.bootcss.com/bootstrap-datepicker/1.7.0-RC2/js/bootstrap-datepicker.min.js"></script>
		<script src="//cdn.bootcss.com/bootstrap-datepicker/1.7.0-RC2/locales/bootstrap-datepicker.zh-CN.min.js" charset="UTF-8"></script>
		<script src="{%resource path='/html/js/datatables.js'%}"></script>
		<script src="{%resource path='/html/js/selector.js'%}"></script>
		<script src="{%resource path='/html/js/brand-selector.js'%}"></script>
		<script src="{%resource path='/html/js/global.js'%}"></script>
		<script type="text/javascript">
			$.ajaxSetup({
				headers:{
					'X-CSRF-TOKEN':'{%$x_csrf_token%}'
				}
			});
			
			$('.input-daterange').datepicker({
				format:'yyyy-mm-dd',
				language: 'zh-CN',
				clearBtn:true,
				todayHighlight:true,
			});
			
			setInterval(function(){
				var datetimeController = new Date();
				var date = datetimeController.getFullYear()+'-'+lpad(datetimeController.getMonth()+1,2)+'-'+lpad(datetimeController.getDate(),2);
				$('.date').text(date);
				
				var time = lpad(datetimeController.getHours(),2)+':'+lpad(datetimeController.getMinutes(),2);
				$('.time').text(time);
			
				var week = datetimeController.getDay();
				var weekArray = ['日','一','二','三','四','五','六'];
				var week = '星期'+weekArray[week];
				$('.week').text(week);
			},1000);
			
			jQuery.validator.addMethod("positiveinteger", function(value, element) {
				var aint=parseInt(value);	
				return aint>0&& (aint+"")==value;   
			}, "请输入正整数.");   
			
			var validate = $('#brandForm').validate({
				errorElement: 'span', //default input error message container
				errorClass: 'help-block', // default input error message class
				focusInvalid: false, // do not focus the last invalid input
				ignore: "",
				rules: {
					day: {
						required: true,
						positiveinteger:true,
					},
					price: {
						required: true
					},
					teamnum: {
						required: true,
						positiveinteger:true,
					},
				},
				messages:{
					day: {
						required: "请填写团购有效期",
						positiveinteger:"团购有效期必须是正整数,单位是天",
					},
					price: {
						required:  "请填写团购价格"
					},
					teamnum: {
						required: "请填写团购人数",
						positiveinteger:"人数必须是正整数",
					}
				},
				highlight: function(element) { // hightlight error inputs
					$(element).closest('.form-group').addClass('has-error'); // set error class to the control group
				},
				success: function(label) {
					label.closest('.form-group').removeClass('has-error');
					label.remove();
				},
				submitHandler:function(form){
					var data = {
						id:'{%$task.id%}',
						start:$(form).find('[name=start]').val(),
						end:$(form).find('[name=end]').val(),
						day:$(form).find('[name=day]').val(),
						price:$(form).find('[name=price]').val(),
						teamnum:$(form).find('[name=teamnum]').val(),
						score:$(form).find('[name=score]').val(),
					};
					$.post('./index.php?m=ajax&c=task&a=save',data,function(response){
						if(response.code==1)
						{
							window.location = './index.php?c=html&a=task';
						}
						else
						{
							bootbox.alert(response.result);
						}
					});
				}
			});
		</script>
	</body>
</html>